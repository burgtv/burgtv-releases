name: Update version.json on Release

on:
  release:
    types: [published]

jobs:
  update-version:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Extract version from tag
        id: version
        run: |
          # Get tag name (e.g., v1.0.6)
          TAG="${{ github.event.release.tag_name }}"
          # Remove 'v' prefix if present
          VERSION_NAME="${TAG#v}"
          # Extract version code from version name (e.g., 1.0.6 -> 6)
          VERSION_CODE=$(echo "$VERSION_NAME" | cut -d'.' -f3)
          # Get changelog from release body (first 200 chars, single line)
          CHANGELOG=$(echo "${{ github.event.release.body }}" | head -c 200 | tr '\n' ' ' | sed 's/"/\\"/g')

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Find APK asset URL
        id: apk
        run: |
          # Get the APK download URL from release assets
          APK_URL=$(echo '${{ toJson(github.event.release.assets) }}' | jq -r '.[] | select(.name | endswith(".apk")) | .browser_download_url' | head -1)
          if [ -z "$APK_URL" ]; then
            # Fallback to standard naming
            APK_URL="https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/app-release.apk"
          fi
          echo "url=$APK_URL" >> $GITHUB_OUTPUT

      - name: Update version.json
        run: |
          cat > version.json << 'EOF'
          {
              "version_code": ${{ steps.version.outputs.version_code }},
              "version_name": "${{ steps.version.outputs.version_name }}",
              "download_url": "${{ steps.apk.outputs.url }}",
              "changelog": "${{ steps.version.outputs.changelog }}",
              "mandatory": false,
              "min_version_code": 1
          }
          EOF

          # Pretty print the JSON
          cat version.json | jq '.' > version_temp.json && mv version_temp.json version.json

          echo "Updated version.json:"
          cat version.json

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add version.json
          git commit -m "Auto-update version.json to ${{ steps.version.outputs.version_name }}" || echo "No changes to commit"
          git push
